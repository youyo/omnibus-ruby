build:
  box:
    id: youyo/vagrant:1.9.1
    cmd: /bin/bash
  steps:
    - script:
      name: create .ssh directory
      code: |-
        mkdir ${HOME}/.ssh

    - create-file:
      name: put private key
      filename: ${HOME}/.ssh/id_rsa
      overwrite: true
      hide-from-log: true
      content: ${SSH_PRIVATE_KEY}

    - create-file:
      name: put public key
      filename: ${HOME}/.ssh/id_rsa.pub
      overwrite: true
      hide-from-log: true
      content: ${SSH_PUBLIC_KEY}

    - script:
      name: Modify Permission
      code: |-
        chmod 700 ${HOME}/.ssh
        chmod 400 ${HOME}/.ssh/id_rsa

    - script:
      name: Build
      code: |-
        vagrant up
        ./fetch_rpm.sh

  after-steps:
    - script:
      name: Destroy VM
      code: |-
        vagrant destroy -f
    - slack-notifier:
      url: ${SLACK_URL}

publish:
  box:
    id: ruby:2.4-alpine
    cmd: /bin/sh
  steps:
    - script:
      name: Publish
      code: |-
        gem install package_cloud
        package_cloud push youyo/omnibus-ruby/${OS_RELEASE} pkg/*.rpm
  after-steps:
    - slack-notifier:
      url: ${SLACK_URL}
